import e from"eventemitter3";import{Room as t,RoomEvent as n,Track as i,RemoteAudioTrack as o}from"livekit-client";function r(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,a(e,t)}function a(e,t){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},a(e,t)}var s=function(e,t){void 0===t&&(t=24e3);try{var n=new MediaStream([e.mediaStreamTrack]);return Promise.resolve(new c(n,t))}catch(e){return Promise.reject(e)}},c=/*#__PURE__*/function(){function e(e,t){void 0===t&&(t=24e3),this.audioContext=void 0,this.sourceNode=void 0,this.analyser=void 0,this.gainNode=void 0,this.closed=!1,this.audioContext=new AudioContext({sampleRate:t}),this.sourceNode=this.audioContext.createMediaStreamSource(e),this.analyser=this.audioContext.createAnalyser(),this.gainNode=this.audioContext.createGain(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=0,this.sourceNode.connect(this.gainNode),this.gainNode.connect(this.analyser)}var t=e.prototype;return t.getPCMFrame=function(){var e=new Float32Array(this.analyser.fftSize);return this.analyser.getFloatTimeDomainData(e),e},t.calculateVolume=function(){var e=this.getPCMFrame();if(0===e.length)return 0;for(var t=0,n=0;n<e.length;n++)t+=e[n]*e[n];var i=Math.sqrt(t/e.length);return Math.min(1,Math.max(0,i))},t.cleanup=function(){try{var e=this;if(e.closed)return Promise.resolve();e.closed=!0;try{e.sourceNode.disconnect(),e.gainNode.disconnect(),e.analyser.disconnect()}catch(e){}var t=function(){try{var t=Promise.resolve(e.audioContext.close()).then(function(){})}catch(e){return}return t&&t.then?t.then(void 0,function(){}):t}();return Promise.resolve(t&&t.then?t.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},e}();function u(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var d=/*#__PURE__*/function(e){function a(){for(var t,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(t=e.call.apply(e,[this].concat(i))||this).isAgentSpeaking=!1,t.audioAnalyzer=void 0,t.room=void 0,t.connected=!1,t.captureAudioFrame=void 0,t}r(a,e);var c=a.prototype;return c.initiateSession=function(e){try{var n=this;return Promise.resolve(u(function(){function i(i){var o=e.sessionToken;return n.room=new t({audioCaptureDefaults:{deviceId:e.inputDeviceId},audioOutput:{deviceId:e.outputDeviceId}}),n.bindRoomEvents(),n.bindDataEvents(),n.bindAudioEvents(e),Promise.resolve(n.room.connect("wss://pia-platform-dev-k9sck0q7.livekit.cloud",o)).then(function(){return Promise.resolve(n.room.localParticipant.setMicrophoneEnabled(!0)).then(function(){n.connected=!0,n.emit("session_connected")})})}if(n.connected&&n.terminateSession(),!e.sessionToken)throw new Error("sessionToken is required. Provide sessionToken in config.");var o=u(function(){return Promise.resolve(navigator.mediaDevices.getUserMedia({audio:!0})).then(function(e){e.getTracks().forEach(function(e){return e.stop()})})},function(e){if("NotAllowedError"===e.name||"PermissionDeniedError"===e.name){var t=new Error("Microphone permission denied. Please allow microphone access to continue.");throw n.emit("microphone_permission_denied",{error:t}),t}if("NotFoundError"===e.name)throw new Error("No microphone device found. Please connect a microphone.");if("NotReadableError"===e.name)throw new Error("Microphone is already in use by another application.");throw e});return o&&o.then?o.then(i):i()},function(e){throw n.emit("session_error",e),n.terminateSession(),e}))}catch(e){return Promise.reject(e)}},c.terminateSession=function(){var e=this.connected;if(this.connected=!1,this.isAgentSpeaking=!1,this.captureAudioFrame&&(globalThis.cancelAnimationFrame(this.captureAudioFrame),this.captureAudioFrame=void 0),this.audioAnalyzer&&(this.audioAnalyzer.cleanup(),this.audioAnalyzer=void 0),this.room){try{this.room.disconnect()}catch(e){}this.room=void 0}e&&this.emit("session_disconnected")},c.mute=function(){this.connected&&this.room&&this.room.localParticipant.setMicrophoneEnabled(!1)},c.unmute=function(){this.connected&&this.room&&this.room.localParticipant.setMicrophoneEnabled(!0)},c.bindRoomEvents=function(){var e=this;this.room&&(this.room.on(n.Disconnected,function(){e.connected&&e.terminateSession()}),this.room.on(n.Reconnecting,function(){e.emit("connection_lost")}),this.room.on(n.Reconnected,function(){e.emit("connection_restored")}),this.room.on(n.ParticipantDisconnected,function(t){"server"===t.identity&&e.terminateSession()}),this.room.on(n.TranscriptionReceived,function(t,n,i){var o=t.map(function(e){var t;return{role:"server"===(null==n?void 0:n.identity)||null!=n&&null!=(t=n.identity)&&t.includes("agent")?"agent":"user",content:e.text,id:e.id,final:e.final,startTime:e.startTime,endTime:e.endTime}});e.emit("transcript_updated",{transcript:o})}))},c.bindAudioEvents=function(e){var t=this;this.room&&this.room.on(n.TrackSubscribed,function(n,r,a){try{if(n.kind!==i.Kind.Audio)return Promise.resolve();n.attach();var c=function(){if(e.enableRawAudio&&n instanceof o){var i=u(function(){var i;return Promise.resolve(s(n,null!=(i=e.audioSampleRate)?i:24e3)).then(function(e){t.audioAnalyzer=e,t.captureAudioSamples()})},function(e){t.emit("session_error",e)});if(i&&i.then)return i.then(function(){})}}();return Promise.resolve(c&&c.then?c.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})},c.captureAudioSamples=function(){var e=this;if(this.connected&&this.audioAnalyzer){var t=this.audioAnalyzer.getPCMFrame();this.emit("audio_stream",t),this.captureAudioFrame=globalThis.requestAnimationFrame(function(){return e.captureAudioSamples()})}},c.bindDataEvents=function(){var e=this;this.room&&this.room.on(n.DataReceived,function(t,n,i,o){var r;try{var a=(new TextDecoder).decode(t);r=JSON.parse(a)}catch(e){return}try{switch(r.event_type||r.type||r.eventType||r.event){case"metadata":e.emit("session_metadata",r);break;case"update":e.emit("transcript_updated",{transcript:r.transcript||r.transcripts||r.messages||[]});break;case"agent_start_talking":e.isAgentSpeaking=!0,e.emit("agent_speech_started");break;case"agent_stop_talking":e.isAgentSpeaking=!1,e.emit("agent_speech_ended")}}catch(e){}})},a}(/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}r(t,e);var n=t.prototype;return n.on=function(t,n,i){return e.prototype.on.call(this,t,n,i)},n.emit=function(t){var n;return(n=e.prototype.emit).call.apply(n,[this,t].concat([].slice.call(arguments,1)))},t}(e));export{c as AudioAnalyzer,d as VerbexWebClient,s as createAudioAnalyzerFromLiveKitTrack};
