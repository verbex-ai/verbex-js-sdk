!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("eventemitter3"),require("livekit-client")):"function"==typeof define&&define.amd?define(["exports","eventemitter3","livekit-client"],t):t((e||self).verbexJsSdk={},e.eventemitter3,e.livekitClient)}(this,function(e,t,n){function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=/*#__PURE__*/o(t);function r(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,a(e,t)}function a(e,t){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},a(e,t)}var s=function(e,t){void 0===t&&(t=24e3);try{var n=new MediaStream([e.mediaStreamTrack]);return Promise.resolve(new c(n,t))}catch(e){return Promise.reject(e)}},c=/*#__PURE__*/function(){function e(e,t){void 0===t&&(t=24e3),this.audioContext=void 0,this.sourceNode=void 0,this.analyser=void 0,this.gainNode=void 0,this.closed=!1,this.audioContext=new AudioContext({sampleRate:t}),this.sourceNode=this.audioContext.createMediaStreamSource(e),this.analyser=this.audioContext.createAnalyser(),this.gainNode=this.audioContext.createGain(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=0,this.sourceNode.connect(this.gainNode),this.gainNode.connect(this.analyser)}var t=e.prototype;return t.getPCMFrame=function(){var e=new Float32Array(this.analyser.fftSize);return this.analyser.getFloatTimeDomainData(e),e},t.calculateVolume=function(){var e=this.getPCMFrame();if(0===e.length)return 0;for(var t=0,n=0;n<e.length;n++)t+=e[n]*e[n];var o=Math.sqrt(t/e.length);return Math.min(1,Math.max(0,o))},t.cleanup=function(){try{var e=this;if(e.closed)return Promise.resolve();e.closed=!0;try{e.sourceNode.disconnect(),e.gainNode.disconnect(),e.analyser.disconnect()}catch(e){}var t=function(){try{var t=Promise.resolve(e.audioContext.close()).then(function(){})}catch(e){return}return t&&t.then?t.then(void 0,function(){}):t}();return Promise.resolve(t&&t.then?t.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},e}();function u(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var d=/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}r(t,e);var n=t.prototype;return n.on=function(t,n,o){return e.prototype.on.call(this,t,n,o)},n.emit=function(t){var n;return(n=e.prototype.emit).call.apply(n,[this,t].concat([].slice.call(arguments,1)))},t}(i.default),h=/*#__PURE__*/function(e){function t(){for(var t,n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return(t=e.call.apply(e,[this].concat(o))||this).isAgentSpeaking=!1,t.audioAnalyzer=void 0,t.room=void 0,t.connected=!1,t.captureAudioFrame=void 0,t}r(t,e);var o=t.prototype;return o.initiateSession=function(e){try{var t=this;return Promise.resolve(u(function(){function o(o){var i=e.sessionToken;return t.room=new n.Room({audioCaptureDefaults:{deviceId:e.inputDeviceId},audioOutput:{deviceId:e.outputDeviceId}}),t.bindRoomEvents(),t.bindDataEvents(),t.bindAudioEvents(e),Promise.resolve(t.room.connect("wss://pia-platform-dev-k9sck0q7.livekit.cloud",i)).then(function(){return Promise.resolve(t.room.localParticipant.setMicrophoneEnabled(!0)).then(function(){t.connected=!0,t.emit("session_connected")})})}if(t.connected&&t.terminateSession(),!e.sessionToken)throw new Error("sessionToken is required. Provide sessionToken in config.");var i=u(function(){return Promise.resolve(navigator.mediaDevices.getUserMedia({audio:!0})).then(function(e){e.getTracks().forEach(function(e){return e.stop()})})},function(e){if("NotAllowedError"===e.name||"PermissionDeniedError"===e.name){var n=new Error("Microphone permission denied. Please allow microphone access to continue.");throw t.emit("microphone_permission_denied",{error:n}),n}if("NotFoundError"===e.name)throw new Error("No microphone device found. Please connect a microphone.");if("NotReadableError"===e.name)throw new Error("Microphone is already in use by another application.");throw e});return i&&i.then?i.then(o):o()},function(e){throw t.emit("session_error",e),t.terminateSession(),e}))}catch(e){return Promise.reject(e)}},o.terminateSession=function(){var e=this.connected;if(this.connected=!1,this.isAgentSpeaking=!1,this.captureAudioFrame&&(globalThis.cancelAnimationFrame(this.captureAudioFrame),this.captureAudioFrame=void 0),this.audioAnalyzer&&(this.audioAnalyzer.cleanup(),this.audioAnalyzer=void 0),this.room){try{this.room.disconnect()}catch(e){}this.room=void 0}e&&this.emit("session_disconnected")},o.mute=function(){this.connected&&this.room&&this.room.localParticipant.setMicrophoneEnabled(!1)},o.unmute=function(){this.connected&&this.room&&this.room.localParticipant.setMicrophoneEnabled(!0)},o.bindRoomEvents=function(){var e=this;this.room&&(this.room.on(n.RoomEvent.Disconnected,function(){e.connected&&e.terminateSession()}),this.room.on(n.RoomEvent.Reconnecting,function(){e.emit("connection_lost")}),this.room.on(n.RoomEvent.Reconnected,function(){e.emit("connection_restored")}),this.room.on(n.RoomEvent.ParticipantDisconnected,function(t){"server"===t.identity&&e.terminateSession()}),this.room.on(n.RoomEvent.TranscriptionReceived,function(t,n,o){var i=t.map(function(e){var t;return{role:"server"===(null==n?void 0:n.identity)||null!=n&&null!=(t=n.identity)&&t.includes("agent")?"agent":"user",content:e.text,id:e.id,final:e.final,startTime:e.startTime,endTime:e.endTime}});e.emit("transcript_updated",{transcript:i})}))},o.bindAudioEvents=function(e){var t=this;this.room&&this.room.on(n.RoomEvent.TrackSubscribed,function(o,i,r){try{if(o.kind!==n.Track.Kind.Audio)return Promise.resolve();o.attach();var a=function(){if(e.enableRawAudio&&o instanceof n.RemoteAudioTrack){var i=u(function(){var n;return Promise.resolve(s(o,null!=(n=e.audioSampleRate)?n:24e3)).then(function(e){t.audioAnalyzer=e,t.captureAudioSamples()})},function(e){t.emit("session_error",e)});if(i&&i.then)return i.then(function(){})}}();return Promise.resolve(a&&a.then?a.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})},o.captureAudioSamples=function(){var e=this;if(this.connected&&this.audioAnalyzer){var t=this.audioAnalyzer.getPCMFrame();this.emit("audio_stream",t),this.captureAudioFrame=globalThis.requestAnimationFrame(function(){return e.captureAudioSamples()})}},o.bindDataEvents=function(){var e=this;this.room&&this.room.on(n.RoomEvent.DataReceived,function(t,n,o,i){var r;try{var a=(new TextDecoder).decode(t);r=JSON.parse(a)}catch(e){return}try{switch(r.event_type||r.type||r.eventType||r.event){case"metadata":e.emit("session_metadata",r);break;case"update":e.emit("transcript_updated",{transcript:r.transcript||r.transcripts||r.messages||[]});break;case"agent_start_talking":e.isAgentSpeaking=!0,e.emit("agent_speech_started");break;case"agent_stop_talking":e.isAgentSpeaking=!1,e.emit("agent_speech_ended")}}catch(e){}})},t}(d);e.AudioAnalyzer=c,e.VerbexWebClient=h,e.createAudioAnalyzerFromLiveKitTrack=s});
