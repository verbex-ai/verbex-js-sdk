var e=require("eventemitter3"),t=require("livekit-client");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=/*#__PURE__*/n(e);function i(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,r(e,t)}function r(e,t){return r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},r(e,t)}var a=function(e,t){void 0===t&&(t=24e3);try{var n=new MediaStream([e.mediaStreamTrack]);return Promise.resolve(new s(n,t))}catch(e){return Promise.reject(e)}},s=/*#__PURE__*/function(){function e(e,t){void 0===t&&(t=24e3),this.audioContext=void 0,this.sourceNode=void 0,this.analyser=void 0,this.gainNode=void 0,this.closed=!1,this.audioContext=new AudioContext({sampleRate:t}),this.sourceNode=this.audioContext.createMediaStreamSource(e),this.analyser=this.audioContext.createAnalyser(),this.gainNode=this.audioContext.createGain(),this.analyser.fftSize=2048,this.analyser.smoothingTimeConstant=0,this.sourceNode.connect(this.gainNode),this.gainNode.connect(this.analyser)}var t=e.prototype;return t.getPCMFrame=function(){var e=new Float32Array(this.analyser.fftSize);return this.analyser.getFloatTimeDomainData(e),e},t.calculateVolume=function(){var e=this.getPCMFrame();if(0===e.length)return 0;for(var t=0,n=0;n<e.length;n++)t+=e[n]*e[n];var o=Math.sqrt(t/e.length);return Math.min(1,Math.max(0,o))},t.cleanup=function(){try{var e=this;if(e.closed)return Promise.resolve();e.closed=!0;try{e.sourceNode.disconnect(),e.gainNode.disconnect(),e.analyser.disconnect()}catch(e){}var t=function(){try{var t=Promise.resolve(e.audioContext.close()).then(function(){})}catch(e){return}return t&&t.then?t.then(void 0,function(){}):t}();return Promise.resolve(t&&t.then?t.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},e}();function c(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var u=/*#__PURE__*/function(e){function n(){for(var t,n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return(t=e.call.apply(e,[this].concat(o))||this).isAgentSpeaking=!1,t.audioAnalyzer=void 0,t.room=void 0,t.connected=!1,t.captureAudioFrame=void 0,t}i(n,e);var o=n.prototype;return o.initiateSession=function(e){try{var n=this;return Promise.resolve(c(function(){function o(o){var i=e.sessionToken;return n.room=new t.Room({audioCaptureDefaults:{deviceId:e.inputDeviceId},audioOutput:{deviceId:e.outputDeviceId}}),n.bindRoomEvents(),n.bindDataEvents(),n.bindAudioEvents(e),Promise.resolve(n.room.connect("wss://pia-platform-dev-k9sck0q7.livekit.cloud",i)).then(function(){return Promise.resolve(n.room.localParticipant.setMicrophoneEnabled(!0)).then(function(){n.connected=!0,n.emit("session_connected")})})}if(n.connected&&n.terminateSession(),!e.sessionToken)throw new Error("sessionToken is required. Provide sessionToken in config.");var i=c(function(){return Promise.resolve(navigator.mediaDevices.getUserMedia({audio:!0})).then(function(e){e.getTracks().forEach(function(e){return e.stop()})})},function(e){if("NotAllowedError"===e.name||"PermissionDeniedError"===e.name){var t=new Error("Microphone permission denied. Please allow microphone access to continue.");throw n.emit("microphone_permission_denied",{error:t}),t}if("NotFoundError"===e.name)throw new Error("No microphone device found. Please connect a microphone.");if("NotReadableError"===e.name)throw new Error("Microphone is already in use by another application.");throw e});return i&&i.then?i.then(o):o()},function(e){throw n.emit("session_error",e),n.terminateSession(),e}))}catch(e){return Promise.reject(e)}},o.terminateSession=function(){var e=this.connected;if(this.connected=!1,this.isAgentSpeaking=!1,this.captureAudioFrame&&(globalThis.cancelAnimationFrame(this.captureAudioFrame),this.captureAudioFrame=void 0),this.audioAnalyzer&&(this.audioAnalyzer.cleanup(),this.audioAnalyzer=void 0),this.room){try{this.room.disconnect()}catch(e){}this.room=void 0}e&&this.emit("session_disconnected")},o.mute=function(){this.connected&&this.room&&this.room.localParticipant.setMicrophoneEnabled(!1)},o.unmute=function(){this.connected&&this.room&&this.room.localParticipant.setMicrophoneEnabled(!0)},o.bindRoomEvents=function(){var e=this;this.room&&(this.room.on(t.RoomEvent.Disconnected,function(){e.connected&&e.terminateSession()}),this.room.on(t.RoomEvent.Reconnecting,function(){e.emit("connection_lost")}),this.room.on(t.RoomEvent.Reconnected,function(){e.emit("connection_restored")}),this.room.on(t.RoomEvent.ParticipantDisconnected,function(t){"server"===t.identity&&e.terminateSession()}),this.room.on(t.RoomEvent.TranscriptionReceived,function(t,n,o){var i=t.map(function(e){var t;return{role:"server"===(null==n?void 0:n.identity)||null!=n&&null!=(t=n.identity)&&t.includes("agent")?"agent":"user",content:e.text,id:e.id,final:e.final,startTime:e.startTime,endTime:e.endTime}});e.emit("transcript_updated",{transcript:i})}))},o.bindAudioEvents=function(e){var n=this;this.room&&this.room.on(t.RoomEvent.TrackSubscribed,function(o,i,r){try{if(o.kind!==t.Track.Kind.Audio)return Promise.resolve();o.attach();var s=function(){if(e.enableRawAudio&&o instanceof t.RemoteAudioTrack){var i=c(function(){var t;return Promise.resolve(a(o,null!=(t=e.audioSampleRate)?t:24e3)).then(function(e){n.audioAnalyzer=e,n.captureAudioSamples()})},function(e){n.emit("session_error",e)});if(i&&i.then)return i.then(function(){})}}();return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(e){return Promise.reject(e)}})},o.captureAudioSamples=function(){var e=this;if(this.connected&&this.audioAnalyzer){var t=this.audioAnalyzer.getPCMFrame();this.emit("audio_stream",t),this.captureAudioFrame=globalThis.requestAnimationFrame(function(){return e.captureAudioSamples()})}},o.bindDataEvents=function(){var e=this;this.room&&this.room.on(t.RoomEvent.DataReceived,function(t,n,o,i){var r;try{var a=(new TextDecoder).decode(t);r=JSON.parse(a)}catch(e){return}try{switch(r.event_type||r.type||r.eventType||r.event){case"metadata":e.emit("session_metadata",r);break;case"update":e.emit("transcript_updated",{transcript:r.transcript||r.transcripts||r.messages||[]});break;case"agent_start_talking":e.isAgentSpeaking=!0,e.emit("agent_speech_started");break;case"agent_stop_talking":e.isAgentSpeaking=!1,e.emit("agent_speech_ended")}}catch(e){}})},n}(/*#__PURE__*/function(e){function t(){return e.apply(this,arguments)||this}i(t,e);var n=t.prototype;return n.on=function(t,n,o){return e.prototype.on.call(this,t,n,o)},n.emit=function(t){var n;return(n=e.prototype.emit).call.apply(n,[this,t].concat([].slice.call(arguments,1)))},t}(o.default));exports.AudioAnalyzer=s,exports.VerbexWebClient=u,exports.createAudioAnalyzerFromLiveKitTrack=a;
